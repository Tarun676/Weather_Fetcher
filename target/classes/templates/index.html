<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Weather App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/styles.css?v=4">
    <script src="/js/weather-bg.js?v=4"></script>

    <!-- Aesthetic fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@400;600;800&display=swap"
        rel="stylesheet">

    <!-- HTMX from WebJar -->
    <script src="/webjars/htmx.org/1.9.10/dist/htmx.min.js"></script>

    <style>
        /* Minimal loading indicator styles */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
        }

        .htmx-request .htmx-indicator {
            opacity: 1;
        }
    </style>
</head>

<body th:class="${weather != null} ? ${weather.condition} : 'Clear'">

    <!-- Main Content Container for HTMX Swapping -->
    <div id="weather-container">

        <!-- Controls -->
        <div class="change-city">
            <!-- Search Form uses HTMX for seamless updates -->
            <form hx-get="/weather" hx-target="body" hx-swap="outerHTML" hx-push-url="true" class="change-city-form">

                <label class="cc-label">Change city</label>
                <input name="city" class="cc-input" type="text" placeholder="Phagwara"
                    th:value="${weather != null} ? ${weather.city} : 'Phagwara'">

                <button class="cc-btn" type="submit">
                    Go <span class="htmx-indicator"></span>
                </button>
            </form>

            <!-- Locate Me Button -->
            <button id="locateBtn" class="cc-btn" style="margin-top: 10px; background: rgba(255,255,255,0.2);"
                type="button">
                üìç Locate Me
            </button>
        </div>

        <!-- Right Side Metrics -->
        <aside class="metrics-panel" role="complementary" aria-label="Weather metrics" th:if="${weather != null}">
            <div class="metric">
                <div class="icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M12 2s-6 6.5-6 10a6 6 0 0 0 12 0c0-3.5-6-10-6-10z" />
                    </svg>
                </div>
                <div class="text">
                    <div class="label">Humidity</div>
                    <div class="value" th:text="${weather.humidity} + '%'">-</div>
                </div>
            </div>

            <div class="metric">
                <div class="icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M4 15a4 4 0 0 1 4-4h1" />
                        <path d="M20 15a4 4 0 0 0-4-4h-1" />
                        <path d="M3 20h14" />
                    </svg>
                </div>
                <div class="text">
                    <div class="label">Condition</div>
                    <div class="value" th:text="${weather.condition}">-</div>
                </div>
            </div>

            <div class="metric">
                <div class="icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M3 11h13M3 7h9M3 15h7" />
                    </svg>
                </div>
                <div class="text">
                    <div class="label">Wind</div>
                    <div class="value" th:text="${weather.windSpeed} + ' m/s'">-</div>
                </div>
            </div>
        </aside>

        <!-- Main Display -->
        <main class="hero" role="main" th:if="${weather != null}">
            <div class="city" th:text="${weather.city} + ', ' + ${weather.country}">Phagwara, IN
            </div>

            <div class="temp" aria-label="Temperature">
                <span class="temp-value" th:text="${weather.temp}">--</span>
                <span class="unit">¬∞C</span>
            </div>

            <div class="condition" th:text="${weather.condition}">Clear</div>
            <div class="feels-like">
                Feels like <span th:text="${weather.feelsLike}">--</span>¬∞C
            </div>
        </main>

        <!-- Forecast (Only show if valid forecast) -->
        <div class="forecast-wrapper" th:if="${forecast != null}">
            <h2 class="forecast-title">5-Day Forecast</h2>

            <div class="forecast">
                <div th:each="f : ${forecast}" class="forecast-item"
                    th:attr="data-date=${f.dateTime},data-cond=${f.condition}">
                    <div class="fi-top">
                        <div class="fi-icon" aria-hidden="true"></div>
                        <!-- Day Name (e.g. Fri) -->
                        <p class="forecast-date" style="margin-bottom:0;" th:text="${f.dayName}"></p>
                        <!-- Date (e.g. 25-12-25) -->
                        <p class="forecast-date-small" style="font-size:0.75rem; opacity:0.8; margin-top:2px;"
                            th:text="${f.readableDate}"></p>
                    </div>
                    <p class="forecast-temp" th:text="${f.temp} + ' ¬∞C'"></p>
                    <p class="forecast-condition" th:text="${f.condition}"></p>
                </div>
            </div>
        </div>

        <!-- Dedicated Error Display -->
        <div th:if="${error != null}" class="error-container">
            <h2 class="error-title">Oops!</h2>
            <p class="error-msg" th:text="${error}">Something went wrong.</p>
        </div>

    </div>

    <!-- Scripts -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.weatherCondition = /*[[${weather != null} ? ${weather.condition} : 'Clear' ]]*/ 'Clear';
        /*]]>*/
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Geolocation Logic
            // Geolocation Logic - Event Delegation for HTMX compatibility
            document.body.addEventListener('click', function (e) {
                if (e.target && e.target.id === 'locateBtn') {
                    const btn = e.target;

                    if (!navigator.geolocation) {
                        alert('Geolocation is not supported by your browser');
                        return;
                    }

                    btn.textContent = 'Locating...';
                    navigator.geolocation.getCurrentPosition((position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        window.location.href = `/weather?lat=${lat}&lon=${lon}`;
                    }, () => {
                        btn.textContent = 'üìç Locate Me';
                        alert('Unable to retrieve your location');
                    });
                }
            });

            const items = document.querySelectorAll('.forecast-item');
            // Removed dayNames array and JS date parsing as it sits in Backend now

            items.forEach(item => {
                const condRaw = item.getAttribute('data-cond') || "";
                const cond = condRaw.toLowerCase();

                // Icon Logic ONLY
                const iconEl = item.querySelector('.fi-icon');
                if (iconEl) {
                    iconEl.innerHTML = getIconSvg(cond);
                    iconEl.setAttribute('title', condRaw);
                }
            });

            function getIconSvg(cond) {
                if (cond.includes('thunder') || cond.includes('storm')) return thunderSvg();
                if (cond.includes('snow')) return snowSvg();
                if (cond.includes('rain') || cond.includes('drizzle')) return rainSvg();
                if (cond.includes('mist') || cond.includes('fog') || cond.includes('haze')) return mistSvg();
                if (cond.includes('cloud')) return cloudsSvg();
                return clearSvg();
            }

            function svgWrap(paths) {
                return `<svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${paths}</svg>`;
            }
            function clearSvg() {
                // Updated sun icon for premium feel
                return svgWrap(`<circle cx="12" cy="12" r="5"/> <path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/>`);
            }
            function cloudsSvg() {
                return svgWrap(`<path d="M6 16a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.2A4.5 4.5 0 0 1 20.5 15H7"/>`);
            }
            function rainSvg() {
                return svgWrap(`<path d="M6 16a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.2A4.5 4.5 0 0 1 20.5 15H7"/> <path d="M8 18l-1 3M12 18l-1 3M16 18l-1 3"/>`);
            }
            function snowSvg() {
                return svgWrap(`<path d="M12 2v20M4 6l16 12M4 18l16-12M6 4l12 16M18 4L6 20"/>`);
            }
            function thunderSvg() {
                return svgWrap(`<path d="M6 16a4 4 0 0 1 0-8 5 5 0 0 1 9.7-1.2A4.5 4.5 0 0 1 20.5 15H7"/> <path d="M13 11l-2 4h3l-2 4"/>`);
            }
            function mistSvg() {
                return svgWrap(`<path d="M3 9h12M6 13h12M4 17h14"/>`);
            }
        });
    </script>
    <script src="/js/weather-bg.js"></script>
</body>

</html>